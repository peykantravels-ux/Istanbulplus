{% extends 'base.html' %} {% load static %} {% block title %}تأیید کد و تنظیم
رمز جدید - Istanbul Plus{% endblock %} {% block extra_css %}
<link rel="stylesheet" href="{% static 'css/style.css' %}" />
{% endblock %} {% block content %}
<div class="container auth-container">
  <div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
      <div class="card auth-card">
        <div class="card-header">
          <h3 class="mb-0">
            <i class="bi bi-shield-check me-2"></i>
            تأیید کد و تنظیم رمز جدید
          </h3>
        </div>
        <div class="card-body">
          <!-- Alert container for messages -->
          <div id="alert-container" class="mb-3"></div>

          <!-- Contact info display -->
          <div class="alert alert-info mb-4">
            <i class="bi bi-info-circle me-2"></i>
            کد تأیید به {% if delivery_method == 'email' %} ایمیل
            <strong>{{ contact_info }}</strong> {% else %} شماره موبایل
            <strong>{{ contact_info }}</strong>
            {% endif %} ارسال شد.
          </div>

          <form id="password-reset-verify-form">
            {% csrf_token %}
            <input
              type="hidden"
              name="contact_info"
              value="{{ contact_info }}"
            />

            <!-- OTP Code field -->
            <div class="form-floating mb-3">
              <input
                type="text"
                class="form-control otp-input"
                id="otp_code"
                name="otp_code"
                placeholder="کد تأیید"
                maxlength="6"
                pattern="[0-9]{6}"
                inputmode="numeric"
                required
              />
              <label for="otp_code">کد تأیید (6 رقم)</label>
              <div class="form-text">کد 6 رقمی ارسال شده را وارد کنید</div>
            </div>

            <!-- New password field -->
            <div class="form-floating mb-3">
              <input
                type="password"
                class="form-control"
                id="new_password"
                name="new_password"
                placeholder="رمز عبور جدید"
                minlength="8"
                required
              />
              <label for="new_password">رمز عبور جدید</label>
              <div class="password-strength">
                <div class="password-strength-bar"></div>
              </div>
              <div class="form-text">حداقل 8 کاراکتر</div>
            </div>

            <!-- Confirm password field -->
            <div class="form-floating mb-4">
              <input
                type="password"
                class="form-control"
                id="confirm_password"
                name="confirm_password"
                placeholder="تأیید رمز عبور"
                minlength="8"
                required
              />
              <label for="confirm_password">تأیید رمز عبور</label>
            </div>

            <!-- Submit button -->
            <div class="d-grid mb-3">
              <button type="submit" class="btn btn-auth">
                <i class="bi bi-check-circle me-2"></i>
                تأیید و تنظیم رمز جدید
              </button>
            </div>

            <!-- Resend code -->
            <div class="text-center mb-3">
              <a
                href="{% url 'users:password-reset-request' %}"
                class="btn btn-secondary-auth"
              >
                <i class="bi bi-arrow-clockwise me-2"></i>
                ارسال مجدد کد
              </a>
            </div>

            <!-- Back to login -->
            <div class="text-center">
              <a href="{% url 'users:login' %}" class="text-decoration-none">
                <i class="bi bi-arrow-left me-1"></i>
                بازگشت به صفحه ورود
              </a>
            </div>
          </form>
        </div>
      </div>

      <!-- Success message (initially hidden) -->
      <div
        class="card auth-card mt-3"
        id="success-container"
        style="display: none"
      >
        <div class="card-body text-center">
          <div class="mb-3">
            <i
              class="bi bi-check-circle-fill text-success"
              style="font-size: 3rem"
            ></i>
          </div>
          <h4 class="text-success mb-3">رمز عبور با موفقیت تغییر یافت!</h4>
          <p class="text-muted mb-4">
            اکنون می‌توانید با رمز عبور جدید وارد شوید.
          </p>
          <a href="{% url 'users:login' %}" class="btn btn-auth">
            <i class="bi bi-box-arrow-in-right me-2"></i>
            ورود به حساب کاربری
          </a>
        </div>
      </div>

      <!-- Help section -->
      <div class="card mt-3">
        <div class="card-body">
          <h6 class="card-title">
            <i class="bi bi-question-circle me-2"></i>
            مشکل در دریافت کد؟
          </h6>
          <ul class="list-unstyled mb-0 small text-muted">
            <li class="mb-1">• کد تأیید تا 5 دقیقه معتبر است</li>
            <li class="mb-1">• پوشه اسپم ایمیل خود را بررسی کنید</li>
            <li class="mb-1">• از اتصال اینترنت مطمئن شوید</li>
            <li>• در صورت مشکل، کد را مجدداً درخواست کنید</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script src="{% static 'js/auth.js' %}"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Auto-format OTP input to only accept numbers
    const otpInput = document.getElementById("otp_code");
    otpInput.addEventListener("input", function (e) {
      this.value = this.value.replace(/[^0-9]/g, "");
    });

    // Password confirmation validation
    const newPassword = document.getElementById("new_password");
    const confirmPassword = document.getElementById("confirm_password");

    function validatePasswordMatch() {
      if (
        confirmPassword.value &&
        confirmPassword.value !== newPassword.value
      ) {
        confirmPassword.setCustomValidity("رمزهای عبور مطابقت ندارند");
      } else {
        confirmPassword.setCustomValidity("");
      }
    }

    confirmPassword.addEventListener("input", validatePasswordMatch);
    newPassword.addEventListener("input", validatePasswordMatch);

    // Override form submission to show success message
    const form = document.getElementById("password-reset-verify-form");
    const originalSubmit = form.onsubmit;

    form.addEventListener("submit", function (e) {
      e.preventDefault();

      // Validate passwords match
      if (newPassword.value !== confirmPassword.value) {
        const authManager = window.authManager || new AuthManager();
        authManager.showMessage("رمزهای عبور مطابقت ندارند", "danger");
        return;
      }

      // Call the auth manager's handler
      const authManager = window.authManager || new AuthManager();
      authManager.handlePasswordResetVerify(e);
    });
  });
</script>
{% endblock %}
